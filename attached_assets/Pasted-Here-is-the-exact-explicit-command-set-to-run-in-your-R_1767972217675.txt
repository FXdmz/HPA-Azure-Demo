Here is the exact, explicit command set to run in your Replit Shell.

This does three things:

Installs the necessary Microsoft SDKs.

Overwrites your server.js with the "Registry Pattern" code (which translates the name "aescher2" into the required ID automatically).

Prints a confirmation when done.

Step 1: The Magic Command
Copy this entire block (scroll to copy all of it), paste it into the Replit Shell tab, and press Enter.

Bash

# 1. Install dependencies
npm install @azure/ai-projects @azure/identity express

# 2. Overwrite server.js with the new "Name Resolution" logic
cat > server.js << 'EOF'
import express from 'express';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { ClientSecretCredential } from '@azure/identity';
import { AIProjectClient } from '@azure/ai-projects';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

const app = express();
app.use(express.json());

const PORT = process.env.PORT || 3001;

// --- CONFIGURATION ---
const connectionString = process.env.AI_FOUNDRY_ENDPOINT;
const targetAgentName = process.env.AI_AGENT_NAME; // "aescher2"
const tenantId = process.env.AZURE_TENANT_ID;
const clientId = process.env.AZURE_CLIENT_ID;
const clientSecret = process.env.AZURE_CLIENT_SECRET;

if (!connectionString || !targetAgentName || !clientId || !clientSecret) {
  console.error("âŒ MISSING SECRETS: Check AI_FOUNDRY_ENDPOINT, AI_AGENT_NAME, AZURE_CLIENT_ID, AZURE_CLIENT_SECRET");
  process.exit(1);
}

// --- AUTHENTICATION ---
const credential = new ClientSecretCredential(tenantId, clientId, clientSecret);
const projectClient = new AIProjectClient(connectionString, credential);

// --- STATE MANAGEMENT ---
const sessions = new Map();
let cachedAgentId = null;

// --- HELPER: The "Registry Pattern" (Name -> ID) ---
async function getAgentIdByName(name) {
  // If we already found it, don't look again
  if (cachedAgentId) return cachedAgentId;

  console.log(`ğŸ” [System] Connecting to Azure to find agent named: "${name}"...`);
  
  try {
    // Get list of all agents in the project
    const response = await projectClient.agents.listAgents();
    
    // Find the one that matches our name
    const agent = response.data.find(a => a.name === name);

    if (!agent) {
      console.error("âŒ [Error] Agent NOT found. Available agents are:");
      response.data.forEach(a => console.log(`   - Name: ${a.name} (ID: ${a.id})`));
      throw new Error(`Agent '${name}' not found in project.`);
    }

    console.log(`âœ… [Success] Found "${agent.name}" -> ID: ${agent.id}`);
    cachedAgentId = agent.id;
    return agent.id;
  } catch (err) {
    console.error("âŒ [Error] Failed to list agents:", err.message);
    throw err;
  }
}

// --- API ROUTES ---
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok', agent: targetAgentName, mode: 'name-resolution' });
});

app.post('/api/chat', async (req, res) => {
  try {
    const { message, sessionId = 'default' } = req.body;
    if (!message) return res.status(400).json({ error: 'Message is required' });

    // 1. RESOLVE NAME TO ID
    const agentId = await getAgentIdByName(targetAgentName);

    // 2. MANAGE THREAD
    let threadId = sessions.get(sessionId);
    if (!threadId) {
      console.log(`ğŸ“ [Thread] Creating new thread for session: ${sessionId}`);
      const thread = await projectClient.agents.createThread();
      threadId = thread.id;
      sessions.set(sessionId, threadId);
    }

    // 3. ADD USER MESSAGE
    await projectClient.agents.createMessage(threadId, {
      role: "user",
      content: message,
    });

    // 4. RUN THE AGENT (SDK handles polling automatically!)
    console.log(`ğŸ¤– [Run] Starting run on thread ${threadId}...`);
    const stream = await projectClient.agents.createRun(threadId, agentId);

    // 5. WAIT FOR RESULT
    // The SDK's poll() method is much safer than a manual while loop
    const runResult = await stream.poll();

    if (runResult.status !== "completed") {
      throw new Error(`Run failed with status: ${runResult.status}`);
    }

    // 6. FETCH ANSWER
    const messages = await projectClient.agents.listMessages(threadId);
    const lastMessage = messages.data[0]; 

    let content = "";
    const sources = [];

    if (lastMessage.role === "assistant") {
      for (const item of lastMessage.content) {
        if (item.type === "text") {
          content += item.text.value;
          // Check for citations
          if (item.text.annotations && item.text.annotations.length > 0) {
             sources.push("MovieLabs OMC"); 
          }
        }
      }
    }

    console.log(`ğŸ“¤ [Response] Sent ${content.length} chars to user.`);
    res.json({
      id: lastMessage.id,
      content: content,
      sources: [...new Set(sources)],
      threadId: threadId
    });

  } catch (error) {
    console.error('ğŸ’¥ [Chat Error]', error);
    // Clear cache on error just in case ID changed
    if (error.message.includes("Agent")) cachedAgentId = null;
    res.status(500).json({ error: error.message });
  }
});

app.post('/api/clear', (req, res) => {
  const { sessionId = 'default' } = req.body;
  sessions.delete(sessionId);
  res.json({ status: 'cleared' });
});

// Serve frontend
app.use(express.static(join(__dirname, 'dist')));
app.get('*', (req, res) => res.sendFile(join(__dirname, 'dist', 'index.html')));

app.listen(PORT, '0.0.0.0', () => {
  console.log(`
  ğŸš€ SERVER STARTED
  ---------------------------------------
  Endpoint:   ${connectionString}
  Agent Name: ${targetAgentName}
  Listening:  http://0.0.0.0:${PORT}
  ---------------------------------------
  `);
});
EOF

echo "âœ… UPDATE COMPLETE: server.js has been rewritten."
Step 2: Verify Your Secrets (One Last Time)
Since this code is now "Smart," it expects the Name, not the ID.

Go to Replit Tools (Lock Icon ğŸ”’).

Set AI_AGENT_NAME to aescher2 (or whatever human-readable name you gave it in Azure).

Set AI_FOUNDRY_ENDPOINT to your https://....services.ai.azure.com/ URL.

Step 3: Run
Click the green Run button.

Watch the console. The first time you chat, it will print: ğŸ” [System] Connecting to Azure to find agent named: "aescher2"...

If it works, it will say: âœ… [Success] Found "aescher2" -> ID: asst_...